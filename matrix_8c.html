<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Matrix-Race: matrix/matrix.c File Reference</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Matrix-Race
   &#160;<span id="projectnumber">v0.1</span>
   </div>
   <div id="projectbrief">A race game for the Robopoly matrix module.</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#define-members">Defines</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">matrix/matrix.c File Reference</div>  </div>
</div>
<div class="contents">
<div class="textblock"><code>#include &lt;avr/io.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="matrix_8h_source.html">matrix.h</a>&quot;</code><br/>
<code>#include &lt;avr/interrupt.h&gt;</code><br/>
</div><div class="textblock"><div class="dynheader">
Include dependency graph for matrix.c:</div>
<div class="dyncontent">
<div class="center"><img src="matrix_8c__incl.png" border="0" usemap="#matrix_2matrix_8c" alt=""/></div>
<map name="matrix_2matrix_8c" id="matrix_2matrix_8c">
<area shape="rect" id="node5" href="matrix_8h.html" title="Functions to draw stuff in the matrix buffer." alt="" coords="92,80,161,107"/></map>
</div>
</div><table class="memberdecls">
<tr><td colspan="2"><h2><a name="define-members"></a>
Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="matrix_8c.html#aa327f246be5e5bbcf38e1f834955192b">draw_buffer</a>&#160;&#160;&#160;(1-<a class="el" href="matrix_8c.html#a956716875b19cb3e39028050665c4981">_active_buffer</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="matrix_8c.html#aaf90fac7eee2dea3a43af17a58e89763">disp_buffer</a>&#160;&#160;&#160;(<a class="el" href="matrix_8c.html#a956716875b19cb3e39028050665c4981">_active_buffer</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="matrix_8c.html#a69423dee7f2ed3e68d6b3aab3cced4a2">BITMASK_AND</a>&#160;&#160;&#160;1</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="matrix_8c.html#a108bfddceb47053def523bdb5b384a37">BITMASK_OR</a>&#160;&#160;&#160;2</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="matrix_8c.html#a3300f7ed4a46b23468b12ca8f38d44ed">BITMASK_XOR</a>&#160;&#160;&#160;3</td></tr>
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="matrix_8c.html#a6fcb2d570fa5cf0fa60e9d2f0ec47db4">_display_next_line</a> (void)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">load the next line from the buffer and display it  <a href="#a6fcb2d570fa5cf0fa60e9d2f0ec47db4"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="matrix_8c.html#aec43762dc86e029b395d4e5819192c2d">ISR</a> (TIMER0_COMPA_vect)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="matrix_8c.html#a24a2e20d62ec1206c2833f140720d852">init_matrix</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="matrix_8c.html#a69259b2d664eefc2c476f7bc334e919d">matrix_clear</a> (void)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Clears entire buffer.  <a href="#a69259b2d664eefc2c476f7bc334e919d"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="matrix_8c.html#a5a28f10819ed671455227f505a04ed81">matrix_set_line</a> (uint8_t line_id, uint8_t values, uint8_t colour)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Set the pixels of a given line.  <a href="#a5a28f10819ed671455227f505a04ed81"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="matrix_8c.html#a3723c52625f8dc2873e7c307e3686508">_matrix_bitmask</a> (uint8_t line_id, uint8_t values, uint8_t colour, uint8_t function)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="matrix_8c.html#a2e177ede912420218593e39341fe7299">switch_buffers</a> (void)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Switch buffers around.  <a href="#a2e177ede912420218593e39341fe7299"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="matrix_8c.html#a6c9a976a0a6f85666c2dde7b471f3026">flip_bits</a> (uint8_t _byte)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">flips the order of bits in a byte  <a href="#a6c9a976a0a6f85666c2dde7b471f3026"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="matrix_8c.html#ac53875d2fe37830e90522c3ae546fc1a">line_callback</a> (uint8_t line_pos)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Callback to be called after every line refresh.  <a href="#ac53875d2fe37830e90522c3ae546fc1a"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="matrix_8c.html#acbd48f05cf98fcb70a572e0ccf66d0e4">frame_callback</a> (void)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">Callback to be called at the end of a frame.  <a href="#acbd48f05cf98fcb70a572e0ccf66d0e4"></a><br/></td></tr>
<tr><td colspan="2"><h2><a name="var-members"></a>
Variables</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="matrix_8c.html#aebcf98832a09195d63942c672f4e8143">_green_buffer</a> [2][8]</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="matrix_8c.html#a2a2f62689c9e08fd4cca02b78f384cb7">_red_buffer</a> [2][8]</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">volatile uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="matrix_8c.html#a956716875b19cb3e39028050665c4981">_active_buffer</a> = 1</td></tr>
</table>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="a69423dee7f2ed3e68d6b3aab3cced4a2"></a><!-- doxytag: member="matrix.c::BITMASK_AND" ref="a69423dee7f2ed3e68d6b3aab3cced4a2" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define BITMASK_AND&#160;&#160;&#160;1</td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a108bfddceb47053def523bdb5b384a37"></a><!-- doxytag: member="matrix.c::BITMASK_OR" ref="a108bfddceb47053def523bdb5b384a37" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define BITMASK_OR&#160;&#160;&#160;2</td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a3300f7ed4a46b23468b12ca8f38d44ed"></a><!-- doxytag: member="matrix.c::BITMASK_XOR" ref="a3300f7ed4a46b23468b12ca8f38d44ed" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define BITMASK_XOR&#160;&#160;&#160;3</td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="aaf90fac7eee2dea3a43af17a58e89763"></a><!-- doxytag: member="matrix.c::disp_buffer" ref="aaf90fac7eee2dea3a43af17a58e89763" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define disp_buffer&#160;&#160;&#160;(<a class="el" href="matrix_8c.html#a956716875b19cb3e39028050665c4981">_active_buffer</a>)</td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="aa327f246be5e5bbcf38e1f834955192b"></a><!-- doxytag: member="matrix.c::draw_buffer" ref="aa327f246be5e5bbcf38e1f834955192b" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define draw_buffer&#160;&#160;&#160;(1-<a class="el" href="matrix_8c.html#a956716875b19cb3e39028050665c4981">_active_buffer</a>)</td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a6fcb2d570fa5cf0fa60e9d2f0ec47db4"></a><!-- doxytag: member="matrix.c::_display_next_line" ref="a6fcb2d570fa5cf0fa60e9d2f0ec47db4" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void _display_next_line </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>load the next line from the buffer and display it </p>
<div class="fragment"><pre class="fragment">{
    <span class="keyword">static</span> uint8_t line_pos = 0;

    <span class="comment">// set anodes corresponding to current line</span>
    <a class="code" href="matrix_8h.html#ac06e38bd44dec45283f4e58e14a11ab9" title="Anode port is active low.">ANODE_PORT</a> = ~_BV(line_pos);

    <span class="comment">// load a line from the buffer and display it</span>
    <a class="code" href="matrix_8h.html#a900bbec351c7a1acd783a1bb9b97b11d" title="Green cathodes (active high)">GREEN_PORT</a> = <a class="code" href="matrix_8c.html#a6c9a976a0a6f85666c2dde7b471f3026" title="flips the order of bits in a byte">flip_bits</a>(<a class="code" href="matrix_8c.html#aebcf98832a09195d63942c672f4e8143">_green_buffer</a>[<a class="code" href="matrix_8c.html#a956716875b19cb3e39028050665c4981">_active_buffer</a>][line_pos]);
    <a class="code" href="matrix_8h.html#a83a0bc04703c97ae283079a399a47cc1" title="Red cathodes (active high)">RED_PORT</a> =   <a class="code" href="matrix_8c.html#a6c9a976a0a6f85666c2dde7b471f3026" title="flips the order of bits in a byte">flip_bits</a>(  <a class="code" href="matrix_8c.html#a2a2f62689c9e08fd4cca02b78f384cb7">_red_buffer</a>[<a class="code" href="matrix_8c.html#a956716875b19cb3e39028050665c4981">_active_buffer</a>][line_pos]);

    line_pos++;
    <span class="comment">// call line_callback(line_pos);</span>

    <span class="keywordflow">if</span>(line_pos &gt;= 8)
    {
        line_pos = 0;

        <span class="comment">// call frame_callback(frame_number);</span>
    }
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="matrix_8c_a6fcb2d570fa5cf0fa60e9d2f0ec47db4_cgraph.png" border="0" usemap="#matrix_8c_a6fcb2d570fa5cf0fa60e9d2f0ec47db4_cgraph" alt=""/></div>
<map name="matrix_8c_a6fcb2d570fa5cf0fa60e9d2f0ec47db4_cgraph" id="matrix_8c_a6fcb2d570fa5cf0fa60e9d2f0ec47db4_cgraph">
<area shape="rect" id="node3" href="matrix_8c.html#a6c9a976a0a6f85666c2dde7b471f3026" title="flips the order of bits in a byte" alt="" coords="184,5,251,32"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="a3723c52625f8dc2873e7c307e3686508"></a><!-- doxytag: member="matrix.c::_matrix_bitmask" ref="a3723c52625f8dc2873e7c307e3686508" args="(uint8_t line_id, uint8_t values, uint8_t colour, uint8_t function)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void _matrix_bitmask </td>
          <td>(</td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>line_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>values</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>colour</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>function</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<div class="fragment"><pre class="fragment">{
    <span class="comment">// since orange == 3, this covers all cases</span>
    <span class="keywordflow">if</span>(colour &amp; <a class="code" href="matrix_8h.html#a625f3fea32732c3fa32f6b3ddd75f905" title="Act on red buffer.">M_RED</a>)
    {
        <span class="keywordflow">if</span>(<span class="keyword">function</span> == <a class="code" href="matrix_8c.html#a69423dee7f2ed3e68d6b3aab3cced4a2">BITMASK_AND</a>)
            <a class="code" href="matrix_8c.html#a2a2f62689c9e08fd4cca02b78f384cb7">_red_buffer</a>[<a class="code" href="matrix_8c.html#aa327f246be5e5bbcf38e1f834955192b">draw_buffer</a>][line_id] &amp;= values;
        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<span class="keyword">function</span> == <a class="code" href="matrix_8c.html#a108bfddceb47053def523bdb5b384a37">BITMASK_OR</a>)
            <a class="code" href="matrix_8c.html#a2a2f62689c9e08fd4cca02b78f384cb7">_red_buffer</a>[<a class="code" href="matrix_8c.html#aa327f246be5e5bbcf38e1f834955192b">draw_buffer</a>][line_id] |= values;
        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<span class="keyword">function</span> == <a class="code" href="matrix_8c.html#a3300f7ed4a46b23468b12ca8f38d44ed">BITMASK_XOR</a>)
            <a class="code" href="matrix_8c.html#a2a2f62689c9e08fd4cca02b78f384cb7">_red_buffer</a>[<a class="code" href="matrix_8c.html#aa327f246be5e5bbcf38e1f834955192b">draw_buffer</a>][line_id] ^= values;
    }
    <span class="keywordflow">if</span>(colour &amp; <a class="code" href="matrix_8h.html#a80b0a7cdacdac141d4b98dafabbd0caa" title="Act on green buffer.">M_GREEN</a>)
    {
        <span class="keywordflow">if</span>(<span class="keyword">function</span> == <a class="code" href="matrix_8c.html#a69423dee7f2ed3e68d6b3aab3cced4a2">BITMASK_AND</a>)
            <a class="code" href="matrix_8c.html#aebcf98832a09195d63942c672f4e8143">_green_buffer</a>[<a class="code" href="matrix_8c.html#aa327f246be5e5bbcf38e1f834955192b">draw_buffer</a>][line_id] &amp;= values;
        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<span class="keyword">function</span> == <a class="code" href="matrix_8c.html#a108bfddceb47053def523bdb5b384a37">BITMASK_OR</a>)
            <a class="code" href="matrix_8c.html#aebcf98832a09195d63942c672f4e8143">_green_buffer</a>[<a class="code" href="matrix_8c.html#aa327f246be5e5bbcf38e1f834955192b">draw_buffer</a>][line_id] |= values;
        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<span class="keyword">function</span> == <a class="code" href="matrix_8c.html#a3300f7ed4a46b23468b12ca8f38d44ed">BITMASK_XOR</a>)
            <a class="code" href="matrix_8c.html#aebcf98832a09195d63942c672f4e8143">_green_buffer</a>[<a class="code" href="matrix_8c.html#aa327f246be5e5bbcf38e1f834955192b">draw_buffer</a>][line_id] ^= values;
    }

    <span class="keywordflow">return</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a6c9a976a0a6f85666c2dde7b471f3026"></a><!-- doxytag: member="matrix.c::flip_bits" ref="a6c9a976a0a6f85666c2dde7b471f3026" args="(uint8_t _byte)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t flip_bits </td>
          <td>(</td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>_byte</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>flips the order of bits in a byte </p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000002">Todo:</a></b></dt><dd>this function is crap. re-implement in assembler! </dd></dl>
<div class="fragment"><pre class="fragment">{
    uint8_t i, output=0;
    uint8_t mask = 0b00000001;
    uint8_t en_mask = 0b10000000;
    <span class="keywordflow">for</span>(i=0; i&lt;8; i++)
    {
        <span class="keywordflow">if</span>((_byte &amp; mask))
        {
            output |= en_mask;
        }
        en_mask &gt;&gt;= 1;
        mask &lt;&lt;= 1;
    }
    <span class="keywordflow">return</span> output;
}
</pre></div>
</div>
</div>
<a class="anchor" id="acbd48f05cf98fcb70a572e0ccf66d0e4"></a><!-- doxytag: member="matrix.c::frame_callback" ref="acbd48f05cf98fcb70a572e0ccf66d0e4" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void frame_callback </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Callback to be called at the end of a frame. </p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000004">Todo:</a></b></dt><dd>replace this function with a pointer to a callback </dd></dl>
<div class="fragment"><pre class="fragment">{
    <span class="keyword">static</span> uint16_t frame_counter = 0;
    <span class="comment">// this function will be called at the end of every frame</span>
    
    frame_counter++;
    <span class="keywordflow">return</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a24a2e20d62ec1206c2833f140720d852"></a><!-- doxytag: member="matrix.c::init_matrix" ref="a24a2e20d62ec1206c2833f140720d852" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void init_matrix </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>We want an 800Hz interrupt. in the documentation, Foc refers to the frequency of the output waveform. Since the output is toggled at every compare, the actual interrupt frequency is twice the frequency of the output compare waveform. Therefore, we only need foc = 400. </p>
<div class="fragment"><pre class="fragment">

                 fclkio
 foc_nx = -------------------
          2 * N * (1 + OCRnx)
 
  </pre></div><p>with fclkio = 14745600, we get <code>N</code> = 64 (prescaler) and <code>OCRnx</code> = 71 (compare value) </p>
<div class="fragment"><pre class="fragment">{
    <span class="comment">/*</span>
<span class="comment">     * set up I/O : LEDs as outputs, buttons as inputs</span>
<span class="comment">     */</span>
    <a class="code" href="matrix_8h.html#a1b69efd31faf5c07a71d692513ae3007">ANODE_DDR</a> = 0xFF;
    <a class="code" href="matrix_8h.html#af6f3b640cb9bb9202423119ac4a10610">RED_DDR</a> = 0xFF;
    <a class="code" href="matrix_8h.html#adddb05ced3a14154ef548ff39ce30035">GREEN_DDR</a> = 0xFF;
    <a class="code" href="matrix_8h.html#ab798f60243a5bba94d99175e4c05d9c1">BUTTON_DDR</a> = 0x00;

    <span class="comment">/*</span>
<span class="comment">     * set up an 800 Hz timer to refresh lines.</span>
<span class="comment">     */</span>
    TCCR0A = (0b10 &lt;&lt; WGM00);   <span class="comment">// Clear timer on compare, OCR0A</span>
    TCCR0B = (0 &lt;&lt; WGM02);
    TCCR0B = (0b100&lt;&lt;CS00);     <span class="comment">// Prescaler = 64</span>
    OCR0A  = 71;                <span class="comment">// Top limit for timer</span>
    TCNT0 = 0;                  <span class="comment">// Just to make sure.</span>

    TIMSK0 |= (1&lt;&lt;OCIE0A);      <span class="comment">// Enable compare interrupt on timer 0 A</span>

    sei();                      <span class="comment">// Enable global interrupts</span>


    <span class="keywordflow">return</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="aec43762dc86e029b395d4e5819192c2d"></a><!-- doxytag: member="matrix.c::ISR" ref="aec43762dc86e029b395d4e5819192c2d" args="(TIMER0_COMPA_vect)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">ISR </td>
          <td>(</td>
          <td class="paramtype">TIMER0_COMPA_vect&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<div class="fragment"><pre class="fragment">{
    <a class="code" href="matrix_8c.html#a6fcb2d570fa5cf0fa60e9d2f0ec47db4" title="load the next line from the buffer and display it">_display_next_line</a>();

    <span class="comment">// check frequency is right by toggling a bit every cycle</span>
    <a class="code" href="matrix_8h.html#ab798f60243a5bba94d99175e4c05d9c1">BUTTON_DDR</a> |= 0x01;
    <a class="code" href="matrix_8h.html#ac8ba909fc8614df64040d2e12c0780e4" title="Buttons are active low!">BUTTON_PORT</a> ^= 0x01;
}
</pre></div>
<p><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="matrix_8c_aec43762dc86e029b395d4e5819192c2d_cgraph.png" border="0" usemap="#matrix_8c_aec43762dc86e029b395d4e5819192c2d_cgraph" alt=""/></div>
<map name="matrix_8c_aec43762dc86e029b395d4e5819192c2d_cgraph" id="matrix_8c_aec43762dc86e029b395d4e5819192c2d_cgraph">
<area shape="rect" id="node3" href="matrix_8c.html#a6fcb2d570fa5cf0fa60e9d2f0ec47db4" title="load the next line from the buffer and display it" alt="" coords="97,5,226,32"/><area shape="rect" id="node5" href="matrix_8c.html#a6c9a976a0a6f85666c2dde7b471f3026" title="flips the order of bits in a byte" alt="" coords="275,5,341,32"/></map>
</div>
</p>

</div>
</div>
<a class="anchor" id="ac53875d2fe37830e90522c3ae546fc1a"></a><!-- doxytag: member="matrix.c::line_callback" ref="ac53875d2fe37830e90522c3ae546fc1a" args="(uint8_t line_pos)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void line_callback </td>
          <td>(</td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>line_pos</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Callback to be called after every line refresh. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">line_pos</td><td>current line (0-7) </td></tr>
  </table>
  </dd>
</dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000003">Todo:</a></b></dt><dd>replace this function with a pointer to a callback </dd></dl>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// this function will be called after every line</span>
    <span class="keywordflow">return</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a69259b2d664eefc2c476f7bc334e919d"></a><!-- doxytag: member="matrix.c::matrix_clear" ref="a69259b2d664eefc2c476f7bc334e919d" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void matrix_clear </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Clears entire buffer. </p>
<div class="fragment"><pre class="fragment">{
    uint8_t i;
    <span class="keywordflow">for</span>(i=0; i&lt;8; i++)
    {
        <a class="code" href="matrix_8c.html#a2a2f62689c9e08fd4cca02b78f384cb7">_red_buffer</a>[<a class="code" href="matrix_8c.html#aa327f246be5e5bbcf38e1f834955192b">draw_buffer</a>][i] = 0;
        <a class="code" href="matrix_8c.html#aebcf98832a09195d63942c672f4e8143">_green_buffer</a>[<a class="code" href="matrix_8c.html#aa327f246be5e5bbcf38e1f834955192b">draw_buffer</a>][i] = 0;
    }
    <span class="keywordflow">return</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a5a28f10819ed671455227f505a04ed81"></a><!-- doxytag: member="matrix.c::matrix_set_line" ref="a5a28f10819ed671455227f505a04ed81" args="(uint8_t line_id, uint8_t values, uint8_t colour)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void matrix_set_line </td>
          <td>(</td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>line_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>values</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>colour</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Set the pixels of a given line. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">line_id</td><td>Matrix line (0 = bottom, 7 = top) </td></tr>
    <tr><td class="paramname">values</td><td>One byte containing pixel values </td></tr>
    <tr><td class="paramname">colour</td><td>Can be either M_RED, M_RED or M_ORANGE </td></tr>
  </table>
  </dd>
</dl>
<div class="fragment"><pre class="fragment">{
    <span class="comment">// since orange == 3, this covers all cases</span>
    <span class="keywordflow">if</span>(colour &amp; <a class="code" href="matrix_8h.html#a625f3fea32732c3fa32f6b3ddd75f905" title="Act on red buffer.">M_RED</a>)
    {
        <a class="code" href="matrix_8c.html#a2a2f62689c9e08fd4cca02b78f384cb7">_red_buffer</a>[<a class="code" href="matrix_8c.html#aa327f246be5e5bbcf38e1f834955192b">draw_buffer</a>][line_id] = values;
    }
    <span class="keywordflow">if</span>(colour &amp; <a class="code" href="matrix_8h.html#a80b0a7cdacdac141d4b98dafabbd0caa" title="Act on green buffer.">M_GREEN</a>)
    {
        <a class="code" href="matrix_8c.html#aebcf98832a09195d63942c672f4e8143">_green_buffer</a>[<a class="code" href="matrix_8c.html#aa327f246be5e5bbcf38e1f834955192b">draw_buffer</a>][line_id] = values;
    }
    <span class="keywordflow">return</span>;
}
</pre></div>
</div>
</div>
<a class="anchor" id="a2e177ede912420218593e39341fe7299"></a><!-- doxytag: member="matrix.c::switch_buffers" ref="a2e177ede912420218593e39341fe7299" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void switch_buffers </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Switch buffers around. </p>
<p>You might want to be careful when calling this function, to do it at the end of a frame, to avoid glitches. </p>
<div class="fragment"><pre class="fragment">{
    <a class="code" href="matrix_8c.html#a956716875b19cb3e39028050665c4981">_active_buffer</a> ^= 1;
}
</pre></div>
</div>
</div>
<hr/><h2>Variable Documentation</h2>
<a class="anchor" id="a956716875b19cb3e39028050665c4981"></a><!-- doxytag: member="matrix.c::_active_buffer" ref="a956716875b19cb3e39028050665c4981" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">volatile uint8_t <a class="el" href="matrix_8c.html#a956716875b19cb3e39028050665c4981">_active_buffer</a> = 1</td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="aebcf98832a09195d63942c672f4e8143"></a><!-- doxytag: member="matrix.c::_green_buffer" ref="aebcf98832a09195d63942c672f4e8143" args="[2][8]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t <a class="el" href="matrix_8c.html#aebcf98832a09195d63942c672f4e8143">_green_buffer</a>[2][8]</td>
        </tr>
      </table>
</div>
<div class="memdoc">
<b>Initial value:</b><div class="fragment"><pre class="fragment"> {
    {
        0b00001000,
        0b00011000,
        0b00101000,
        0b00001000,
        0b00001000,
        0b00001000,
        0b00111110,
        0b00000000
    },
    {
        0b00011100,
        0b00100010,
        0b00000010,
        0b00000100,
        0b00001000,
        0b00010000,
        0b00111110,
        0b00000000
    }
}
</pre></div><p>for double-buffering, let's store two tables of 8x8 pixels in RAM </p>

</div>
</div>
<a class="anchor" id="a2a2f62689c9e08fd4cca02b78f384cb7"></a><!-- doxytag: member="matrix.c::_red_buffer" ref="a2a2f62689c9e08fd4cca02b78f384cb7" args="[2][8]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t <a class="el" href="matrix_8c.html#a2a2f62689c9e08fd4cca02b78f384cb7">_red_buffer</a>[2][8]</td>
        </tr>
      </table>
</div>
<div class="memdoc">
<b>Initial value:</b><div class="fragment"><pre class="fragment"> {
    {
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000
    },
    {
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000,
        0b00000000
    }
}
</pre></div>
</div>
</div>
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Mon Oct 24 2011 19:18:27 for Matrix-Race by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.5.1
</small></address>

</body>
</html>
